---
title: "003-ElasticSearch.md"
date: 2025-12-27 18:34:01
tags: []
---

### 1. 为什么要用 ES？不用 MySQL 行不行？
ES（Elasticsearch）和 MySQL 定位完全不同，**ES 专为全文检索、数据分析设计，MySQL 专为关系型数据存储、事务性操作设计**

ES （倒排索引）：
- **倒排索引是全文检索引擎的核心数据结构**，它以 “关键词” 为中心，记录每个关键词出现在哪些文档（或记录）中，以及出现的位置、频次等信息
- 

适合场景：
- 全文检索
- 大数据量聚合分析
- 地理位置检索
- 日志检索分析

MySQL（B+树索引）：
- 简单精确查询
- 事务性操作
- 小数据量简单模糊查询

> 正排索引：书的目录 → 章节 → 章节内的内容关键词  
> 倒排索引：书的索引表 → 关键词 → 该关键词出现在哪些章节、哪些页码

| 结构 | 作用 |
|------|------|
| 词典（Dictionary） | 存储所有去重后的关键词（Term），是倒排索引的 “索引的索引”，通常用哈希表或 B + 树存储，用于快速查找关键词。 |
| 倒排列表（Posting List） | 每个关键词对应一个倒排列表，存储该关键词出现的文档 ID 集合，以及可选的附加信息（如出现位置、频次、权重）。 |

> B + 树索引是**关系型数据库和有序存储引擎的核心索引结构**，它是一种 **平衡多路查找树**，**所有数据都存储在叶子节点，且叶子节点按索引键值有序排列，并通过双向链表连接**


👉 **ES ≠ 数据库替代品**

---

### 2. ES 的核心概念？

| ES 核心概念 | MySQL 对应概念 | 核心作用 | 关键说明 |
|-------------|----------------|----------|----------|
| Index（索引） | Database（数据库） | 存储一类相似结构的文档 | 1. 索引是 ES 中最高级别的数据组织单位，一个索引对应一类业务数据（如 product_index 存储商品、order_index 存储订单）；<br>2. 索引名必须小写，不能包含特殊字符；<br>3. 索引会被分片存储到多个节点，实现分布式扩容。 |
| Type（类型） | Table（表） | 索引内的文档分类（ES 7.x 已废弃） | 1. ES 5.x/6.x 中，一个索引可以包含多个 Type（如 user_index 包含 vip_user 和 normal_user 两个 Type）；<br>2. ES 7.x 及以后，Type 被废弃，一个索引只能存储一类文档，Type 默认为 _doc；<br>3. 废弃原因：不同 Type 共用同一索引的分片，会导致资源竞争和数据混乱。 |
| Document（文档） | Row（行） | ES 的最小数据单元 | 1. 文档是 JSON 格式的数据，每个文档有唯一 ID（手动指定或 ES 自动生成）；<br>2. 文档属于某个索引，相当于 MySQL 表中的一行数据；<br>3. 文档是无模式（schema-less） 的，允许同一索引下的文档有不同字段（但实际开发中会尽量保持字段一致）。 |
| Field（字段） | Column（列） | 文档的属性 | 1. 每个字段有对应的数据类型（如 text 文本、keyword 关键字、integer 整数、date 日期）；<br>2. 字段类型决定了该字段能否被检索、如何被检索：<br>- text 类型：会被分词（如 “华为手机” 拆分为 “华为”“手机”），支持全文检索；<br>- keyword 类型：不会被分词，支持精确匹配和聚合分析。 |
| Mapping（映射） | Table Schema（表结构） | 定义文档的字段类型、分词器等属性 | 1. Mapping 相当于 MySQL 的表结构定义，明确每个字段的数据类型和检索规则；<br>2. ES 支持动态映射：写入文档时自动推断字段类型（如数字→long，字符串→text+keyword）；<br>3. 生产环境建议手动创建 Mapping，避免动态映射推断错误（如把 “100” 识别为 long 而非 keyword）。 |


---

### 3. ES 为什么快？
- 倒排索引为核心的存储结构
- 分布式并行计算
- 检索流程深度优化（利用内存缓存了热数据的倒排索引和文档数据）

---

### 4. 倒排索引是什么？
> 倒排索引：书的索引表 → 关键词 → 该关键词出现在哪些章节、哪些页码

| 结构 | 作用 |
|------|------|
| 词典（Dictionary） | 存储所有去重后的关键词（Term），是倒排索引的 “索引的索引”，通常用哈希表或 B + 树存储，用于快速查找关键词。 |
| 倒排列表（Posting List） | 每个关键词对应一个倒排列表，存储该关键词出现的文档 ID 集合，以及可选的附加信息（如出现位置、频次、权重）。 |

- 词 → 文档列表
- 非逐行扫描
- 适合全文搜索

---

### 5. ES 分片与副本的作用？
分片（Shard）和副本（Replica）是 Elasticsearch 实现 **分布式存储、高可用、高并发检索** 的两大核心机制

#### （一） 分片（Shard）的作用
分片是 ES 将一个索引的数据 **水平拆分** 后的最小存储单元，每个分片本质上是一个独立的 Lucene 索引，拥有完整的倒排索引结构。

##### 1. 核心作用 1：突破单节点硬件限制，实现水平扩容
ES 单个节点的内存、磁盘容量有限，无法存储海量数据（比如亿级文档）。
通过分片，一个索引的数据被拆分成多个部分，分布在不同的节点上。
- 示例：一个 100GB 的索引拆分为 5 个分片，每个分片约 20GB，可分别部署在 5 个节点上，避免单节点磁盘过载。
- 关键特性：索引创建后，**主分片数量不可修改**（副本数量可动态调整），因此创建索引时需提前规划分片数（参考：单分片大小建议 20~50GB）。

##### 2. 核心作用 2：实现并行检索，提升查询性能
当发起检索请求时，ES 的协调节点会将请求 **并行分发** 到该索引的所有分片上。
每个分片独立执行查询，然后将结果返回给协调节点，协调节点合并结果后返回给客户端。
- 性能优势：理论上，分片数越多，并行度越高，检索速度越快（需注意：分片数过多会增加调度开销，需合理规划）。

#### （二） 副本（Replica）的作用
副本是主分片的 **冗余备份**，一个主分片可以对应多个副本分片，副本和主分片的数据完全一致。

##### 1. 核心作用 1：保证数据高可用，避免单点故障
当主分片所在的节点宕机时，ES 集群会自动将该主分片的某个副本分片 **提升为主分片**，继续提供服务，数据不会丢失。
- 可用性保障：副本数量越多，高可用能力越强（比如 1 个主分片 + 2 个副本，即使两个节点宕机，仍有 1 个副本可用）。

##### 2. 核心作用 2：分担检索压力，提升并发读性能
副本分片和主分片一样，拥有完整的索引数据，支持检索请求。
ES 会将检索请求均匀分发到主分片和所有副本分片上，大幅提升系统的并发读能力。
- 示例：1 个主分片 + 1 个副本，检索并发量理论上可提升 1 倍；1 个主分片 + 2 个副本，并发量可提升 2 倍。

##### 3. 副本的关键特性
- 副本分片 **不能和对应的主分片部署在同一个节点**（否则节点宕机时，主分片和副本同时丢失，失去备份意义）。
- 副本数量可 **动态调整**（无需重建索引），生产环境可根据业务压力随时扩容 / 缩容。

#### 总结
| 机制 | 核心作用 | 关键价值 |
|------|----------|----------|
| 分片（Shard） | 1. 水平拆分数据，突破单节点限制<br>2. 并行检索，提升查询速度 | 支撑海量数据存储，提升检索性能 |
| 副本（Replica） | 1. 冗余备份，保证数据高可用<br>2. 分担读压力，提升并发能力 | 避免数据丢失，支撑高并发检索 |
---

### 6. ES 写入流程？

- 客户端发送写入请求到协调节点
- 协调节点根据路由规则（默认按文档 ID 哈希），将请求路由到对应的主分片
- 主分片写入数据并同步到其所有副本分片
- 所有副本分片写入成功后，主分片返回成功响应给客户端

---

### 7. ES 数据检索流程？
- 客户端发送检索请求到协调节点
- 协调节点将请求分发到该索引的 **所有主分片和副本分片**（或随机选择部分分片，取决于查询类型）
- 各分片并行执行查询，返回匹配的文档 ID 和评分
- 协调节点合并所有分片的结果，按评分排序后，获取前 N 条文档的完整数据，返回给客户端
---

### 8. ES 如何保证数据不丢？

- **副本冗余**：主分片 + 副本分片多副本存储，节点宕机不丢数据
- **translog 持久化**：内存数据写入时同步刷盘，宕机后可恢复未持久化数据
- 故障自动转移：节点宕机后自动提升副本为主分片，快速恢复服务
- **一致性控制**：写入时校验分片可用性，从源头保证写入可靠性

---

### 9. ES 查询优化手段？

- 避免深度分页
- 合理分片数量
- 关闭无用字段索引
- 利用缓存：**filter 子句**、文件系统缓存能大幅提升性能；
- 索引层优先：好的索引设计是性能的基础，比优化查询语句更重要；
- 避免全扫描：任何导致全索引 / 全分片扫描的查询都是性能杀手；
- 合理分配资源：内存、SSD 是 ES 性能的关键硬件保障。
---

### 10. ES 和 Mysql中数据如何保持一致性？

- 强一致性需求 → 选择 同步双写
- 高性能、高并发需求 → 选择 Canal 异步同步
- 数据一致性兜底 → 搭配 定时全量同步
- 本地消息表（最终一致性）
---


