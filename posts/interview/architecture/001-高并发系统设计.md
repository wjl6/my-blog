---
title: "001-高并发系统设计.md"
date: 2025-12-28 15:45:02
tags: []
---

## 1. 什么是高并发？核心难点是什么？

### 一、 什么是高并发？
高并发是指系统在单位时间内需要处理海量的请求（或任务），通常用 **QPS（每秒查询数）、TPS（每秒事务数）、并发用户数** 三个指标衡量，核心是在高请求压力下，系统仍能保持稳定、低延迟、高可用的服务能力。

#### 1. 量化指标（以互联网系统为例）
| 指标 | 含义 | 低并发 | 中高并发 | 超高并发 |
|------|------|--------|----------|----------|
| QPS | 每秒处理的查询请求数 | ＜ 100 | 1000 ~ 10000 | ＞ 10 万（如电商秒杀、双 11） |
| TPS | 每秒处理的事务数（含写操作） | ＜ 50 | 500 ~ 5000 | ＞ 1 万（如订单创建、支付） |
| 并发用户数 | 同时在线并发起请求的用户数 | ＜ 100 | 1 万～10 万 | ＞ 100 万（如社交平台峰值） |

### 2. 高并发的核心特征
- **请求密集**：单位时间内请求量远超系统常规负载；
- **资源竞争**：CPU、内存、磁盘 I/O、网络带宽、数据库连接等资源被大量抢占；
- **强实时性**：用户对响应延迟敏感（如秒杀场景要求 100ms 内响应）；
- **高可用要求**：不允许单点故障，需保证 99.9% 以上的服务可用性。

### 二、 高并发的核心难点
高并发的难点本质是 **「有限的系统资源」与「无限的用户请求」** 之间的矛盾，具体体现在 **资源瓶颈、数据一致性、系统稳定性、峰值应对** 四个维度，每个维度都存在技术挑战：

#### 1. 难点 1：资源瓶颈 —— 系统硬件 / 软件资源的极限约束
系统的处理能力最终受限于底层资源，高并发下资源瓶颈会被无限放大：
- **CPU 瓶颈**：
  高并发下大量线程上下文切换、锁竞争（如 `synchronized` 锁）会导致 CPU 利用率飙升至 100%，但有效计算占比极低；
  复杂计算（如数据聚合、全文检索）会占用大量 CPU 时间片，导致请求排队。
  典型问题：系统响应延迟陡增，出现 CPU 负载过高告警。

- **内存瓶颈**：
  缓存穿透 / 击穿 / 雪崩会导致大量请求穿透到数据库，同时缓存服务器内存溢出（OOM）；
  JVM 堆内存不足、GC 频繁（尤其是 Full GC）会导致系统停顿，无法处理请求。
  典型问题：服务进程崩溃、OOM 异常、GC 耗时过长。

- **磁盘 I/O 瓶颈**：
  数据库频繁写操作（如订单入库）会导致磁盘随机 I/O 飙升，机械硬盘的 I/O 性能极限约为 100 ~ 200 IOPS，远无法满足高并发写需求；
  日志、文件的大量读写会抢占磁盘带宽，导致数据库、缓存等核心服务 I/O 阻塞。

- **网络瓶颈**：
  服务器网卡带宽被打满（如 1G 网卡每秒最多处理约 100MB 数据），导致请求无法进出；
  网络延迟、丢包会导致分布式系统中节点间通信超时，引发重试风暴。

#### 2. 难点 2：数据一致性 —— 分布式场景下的数据正确性保障
高并发系统通常是分布式架构（多实例、多数据库），数据一致性是最大的技术坑：
- **分布式事务问题**：
  跨服务 / 跨数据库的操作（如「扣库存 → 生成订单 → 减余额」）无法用单机事务保证，若采用 2PC 协议会导致性能低下，采用最终一致性则可能出现数据不一致（如库存扣了但订单没生成）。
  典型场景：电商订单创建、支付转账。

- **缓存与数据库一致性**：
  缓存更新策略不当（如先更数据库再更缓存）会导致缓存脏数据；
  并发写场景下，多个请求同时更新缓存 / 数据库，会出现数据覆盖、版本冲突。

- **分布式锁问题**：
  分布式锁实现不当（如 Redis 锁未续期、ZooKeeper 锁性能低）会导致锁失效，引发超卖、重复下单等严重问题；
  锁粒度太粗会导致并发性能下降，粒度太细则增加系统复杂度。

#### 3. 难点 3：系统稳定性 —— 避免雪崩效应与服务降级失控
高并发下，系统的脆弱性会被放大，一个小问题可能引发连锁反应：
- **雪崩效应**：
  单个服务节点宕机 → 负载均衡将请求转发到其他节点 → 其他节点因压力过大也宕机 → 最终整个服务集群崩溃；
  典型场景：缓存雪崩导致数据库压力骤增，数据库宕机后引发整个电商系统瘫痪。

- **服务降级 / 熔断的权衡**：
  降级规则设计不当（如降级核心功能）会导致用户体验极差；
  熔断阈值设置不合理（如阈值太低导致正常请求被熔断，阈值太高无法保护系统）；
  难点：如何在保证核心功能可用和保护系统不被压垮之间找到平衡。

- **流量削峰的挑战**：
  秒杀、抢购等场景的流量是脉冲式峰值（瞬时 QPS 是平时的 100 倍），直接打到系统会导致瞬间崩溃；
  削峰方案（如队列、排队、预扣库存）的设计复杂，需考虑队列满了怎么办、排队超时如何处理等问题。

#### 4. 难点 4：峰值应对 —— 无法预测的流量波动
高并发系统的流量往往是不可预测的，比如热点事件、促销活动会导致流量突然飙升，核心难点在于：
- **容量评估难**：
  无法准确预测峰值流量，扩容太早会浪费资源，扩容太晚则无法应对峰值；
  分布式系统的容量评估需要考虑木桶效应（系统性能由最弱的组件决定，如数据库、缓存）。

- **弹性伸缩难**：
  云服务器的弹性伸缩需要时间（分钟级），无法应对秒级的流量峰值；
  伸缩策略需精准匹配业务流量（如根据 CPU 利用率、QPS 自动扩容 / 缩容），否则会导致伸缩震荡（频繁扩容缩容）。

- **热点问题**：
  热点数据：如某款秒杀商品的 ID 被大量请求，导致缓存服务器的某个分片压力过大（数据倾斜）；
  热点接口：如首页接口、登录接口被频繁调用，成为系统瓶颈；
  难点：如何快速发现并隔离热点，避免热点扩散导致全系统压力过大。

### 三、 高并发的核心解决思路（总结）
解决高并发问题的核心是 **「避峰、削峰、填谷、扩容、优化」**：
1. **避峰**：通过业务设计分散流量（如错峰促销、预约抢购）；
2. **削峰**：用队列、缓存、限流等手段平滑流量峰值；
3. **填谷**：利用异步化、批处理提升资源利用率；
4. **扩容**：水平扩容（增加节点）而非垂直扩容（升级硬件），突破单机瓶颈；
5. **优化**：从代码、SQL、缓存、JVM 等层面优化，提升单机处理能力。

---

## 2. 高并发系统的通用设计原则？

四个关键词：
- **限流**
- **缓存**
- **异步**
- **拆分**

---

## 3. 如何做系统限流？

常见方案：
- Nginx 限流
- 接口限流（令牌桶 / 漏桶）
- 网关限流

---

## 4. 如何应对流量突增（削峰填谷）？

- MQ 异步化
- 队列缓冲
- 拒绝非核心请求

---

## 5. 高并发下库存扣减如何设计？
高并发下直接操作数据库会导致性能瓶颈，必须采用 「**缓存层预扣减 → 数据库层最终扣减 → 异步兜底校验**」 的分层架构，兼顾性能和一致性。
```text
用户下单 → 1.缓存层预扣减 → 2.分布式锁（乐观锁）兜底 → 3.数据库层预占库存 → 4.订单创建成功 → 5.数据库层扣减物理库存 → 6.订单超时/取消 → 7.释放预占库存
```

---

## 6. 如何防止超卖？

- 库存原子扣减
- 幂等校验

---

## 7. 高并发下如何保证接口幂等？

常见手段：
- 唯一业务 ID
- Redis 去重
- 数据库唯一索引

---

## 8. 高并发系统如何拆分？

- 按业务域拆分（推荐）
- 读写分离
- 热点数据隔离

---

